---
title: "abundance-nasa-markdown"
output:
  html_document: default
  pdf_document: default
date: "2025-08-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

#Open packages necessary for this analysis.
```{r}
library(readr)
library(nasapower)
library(tidyverse)
library(magrittr)
library(ggplot2)
library(dplyr)
library(gridExtra)
library(forecast)
```
 
#Open the sheet with SWD count data from local folder. 
```{r}
SWD_data <- read_csv("C:/Users/maria/OneDrive/Desktop/abundance-nasa/NEW CLEAN EXCEL Nunez SWD Sorting Sheet June 2024 for abundance-nasa(Data).csv")
```

#Download NASA data on Temperature (T2M) for locations of interest by using farm coordinates.
```{r}
#VT Farms
ABF_weather <- get_power(
  community = "ag",
  lonlat = c(-73.1885194,44.29804),
  pars = c("T2M"),
  dates = c("2022-01-01", 
            paste(2025, "-08-20", sep = "")),
  temporal_api = "daily"
)
FBF_weather <- get_power(
  community = "ag",
  lonlat = c(-73.1334011,44.265172),
  pars = c("T2M"),
  dates = c("2022-01-01", 
            paste(2025, "-08-20", sep = "")),
  temporal_api = "daily"
)
#KY farms
LBA_weather <- get_power(
  community = "ag",
  lonlat = c(-84.6058,38.0408),
  pars = c("T2M"),
  dates = c("2020-01-01", 
            paste(2025, "-08-20", sep = "")),
  temporal_api = "daily"
)
CM_weather <- get_power(
  community = "ag",
  lonlat = c(-78.5447915,37.9740223),
  pars = c("T2M"),
  dates = c("2017-01-01", 
            paste(2025, "-08-20", sep = "")),
  temporal_api = "daily"
)
#VA farms
AlBe_weather <- get_power(
  community = "ag",
  lonlat = c(-79.081904,38.146223),
  pars = c("T2M"),
  dates = c("2021-01-01", 
            paste(2025, "-08-20", sep = "")),
  temporal_api = "daily"
)
FrSa_weather <- get_power(
  community = "ag",
  lonlat = c(-78.8319075,38.3967029),
  pars = c("T2M"),
  dates = c("2021-01-01", 
            paste(2025, "-08-20", sep = "")),
  temporal_api = "daily"
)
```

#Clean up datasets so that they are streamlined and funcitonal for figure generation 
```{r}
#CombineLatLon data into one variable "Coordinates", because local SWD collection data is given "Coordinates" while NASA downloaded data is given "LAT" and "LON"
FBF_weather$Coordinates<- paste(FBF_weather$LAT, FBF_weather$LON,sep=",")
ABF_weather$Coordinates<- paste(ABF_weather$LAT, ABF_weather$LON,sep=",")
LBA_weather$Coordinates<- paste(LBA_weather$LAT, LBA_weather$LON,sep=",")
CM_weather$Coordinates<- paste(CM_weather$LAT, CM_weather$LON,sep=",")
FrSa_weather$Coordinates<- paste(FrSa_weather$LAT, FrSa_weather$LON,sep=",")
AlBe_weather$Coordinates<- paste(AlBe_weather$LAT, AlBe_weather$LON,sep=",")

#Remove columns that we do not need for our analysis. DD,MM,and YYYY are removed because there is already a separate column for DD-MM-YYYY.
FBF_weather$DD<-NULL
FBF_weather$MM<-NULL
FBF_weather$YYYY<-NULL
FBF_weather$DOY<-NULL
ABF_weather$DD<-NULL
ABF_weather$DOY<-NULL
ABF_weather$MM<-NULL
ABF_weather$YYYY<-NULL
FrSa_weather$DD<-NULL
FrSa_weather$DOY<-NULL
FrSa_weather$MM<-NULL
FrSa_weather$YYYY<-NULL
AlBe_weather$DD<-NULL
AlBe_weather$DOY<-NULL
AlBe_weather$MM<-NULL
AlBe_weather$YYYY<-NULL
LBA_weather$DD<-NULL
LBA_weather$DOY<-NULL
LBA_weather$MM<-NULL
LBA_weather$YYYY<-NULL
CM_weather$DD<-NULL
CM_weather$DOY<-NULL
CM_weather$MM<-NULL
CM_weather$YYYY<-NULL

#save YYYYMMDD as a date 
SWD_data$YYYYMMDD <-as.Date(SWD_data$YYYYMMDD, format = "%Y-%m-%d")
ABF_weather$YYYYMMDD <- as.Date(ABF_weather$YYYYMMDD, format = "%Y-%m-%d")
FBF_weather$YYYYMMDD <- as.Date(FBF_weather$YYYYMMDD, format = "%Y-%m-%d")
CM_weather$YYYYMMDD <- as.Date(CM_weather$YYYYMMDD, format = "%Y-%m-%d")
LBA_weather$YYYYMMDD <- as.Date(LBA_weather$YYYYMMDD, format = "%Y-%m-%d")
FrSa_weather$YYYYMMDD <- as.Date(FrSa_weather$YYYYMMDD, format = "%Y-%m-%d")
AlBe_weather$YYYYMMDD <- as.Date(AlBe_weather$YYYYMMDD, format = "%Y-%m-%d")

#Ensure that variables are factor columns, rather than numeric.
AbundanceTempFBF$T2M <- as.numeric(as.character(AbundanceTempFBF$T2M))
AbundanceTempFBF$N_swd<-as.numeric(as.character(AbundanceTempFBF$N_swd))
AbundanceTempABF$T2M <- as.numeric(as.character(AbundanceTempABF$T2M))
AbundanceTempABF$N_swd<-as.numeric(as.character(AbundanceTempABF$N_swd))
AbundanceTempLBA$T2M <- as.numeric(as.character(AbundanceTempLBA$T2M))
AbundanceTempLBA$N_swd<-as.numeric(as.character(AbundanceTempLBA$N_swd))
AbundanceTempCM$T2M <- as.numeric(as.character(AbundanceTempCM$T2M))
AbundanceTempCM$N_swd<-as.numeric(as.character(AbundanceTempCM$N_swd))
AbundanceTempFrSa$T2M <- as.numeric(as.character(AbundanceTempFrSa$T2M))
AbundanceTempFrSa$N_swd<-as.numeric(as.character(AbundanceTempFrSa$N_swd))
AbundanceTempAlBe$T2M <- as.numeric(as.character(AbundanceTempAlBe$T2M))
AbundanceTempAlBe$N_swd<-as.numeric(as.character(AbundanceTempAlBe$N_swd))
```

#Create a dataframe that combines SWD data with weather data for each farm. A right_join is used to maintain all weather data even for dates that do not have N_swd counts, so that T2M remains continous for graphing.
```{r}
AbundanceTempFBF<-right_join(SWD_data, FBF_weather, by = c("Coordinates","YYYYMMDD"))
AbundanceTempABF<-right_join(SWD_data, ABF_weather, by = c("Coordinates","YYYYMMDD"))
AbundanceTempCM<-right_join(SWD_data, CM_weather, by = c("Coordinates","YYYYMMDD"))
AbundanceTempLBA<-right_join(SWD_data, LBA_weather, by = c("Coordinates","YYYYMMDD"))
AbundanceTempFrSa<-right_join(SWD_data, FrSa_weather, by = c("Coordinates","YYYYMMDD"))
AbundanceTempAlBe<-right_join(SWD_data, AlBe_weather, by = c("Coordinates","YYYYMMDD"))
```

#In order to create a cross-correlation analysis comparing temperature to a lagged version of N_swd, we must generate interpolated values for N_swd based on temperature.
```{r}
# create 50 points of interpolated data for FBF flies
swd_interpolatedFBF<-approx(y = AbundanceTempFBF$N_swd, x = AbundanceTempFBF$T2M, method = "linear", n = 50,
          rule = 1, f = 0, ties = mean, na.rm = TRUE)
swd_interpolatedFBF<-data.frame(swd_interpolatedFBF)
colnames(swd_interpolatedFBF)[colnames(swd_interpolatedFBF) == "x"] <- "T2M"
colnames(swd_interpolatedFBF)[colnames(swd_interpolatedFBF) == "y"] <- "N_swd"

# create 50 points of interpolated data for ABF flies
swd_interpolatedABF<-approx(y = AbundanceTempABF$N_swd, x = AbundanceTempABF$T2M, method = "linear", n = 50,
          rule = 1, f = 0, ties = mean, na.rm = TRUE)
swd_interpolatedABF<-data.frame(swd_interpolatedABF)
colnames(swd_interpolatedABF)[colnames(swd_interpolatedABF) == "x"] <- "T2M"
colnames(swd_interpolatedABF)[colnames(swd_interpolatedABF) == "y"] <- "N_swd"

# create 50 points of interpolated data for CM flies
swd_interpolatedCM<-approx(y = AbundanceTempCM$N_swd, x = AbundanceTempCM$T2M, method = "linear", n = 50,
          rule = 1, f = 0, ties = mean, na.rm = TRUE)
swd_interpolatedCM<-data.frame(swd_interpolatedCM)
colnames(swd_interpolatedCM)[colnames(swd_interpolatedCM) == "x"] <- "T2M" 
colnames(swd_interpolatedCM)[colnames(swd_interpolatedCM) == "y"] <- "N_swd"

# create 50 points of interpolated data for LBA flies
swd_interpolatedLBA<-approx(y = AbundanceTempLBA$N_swd, x = AbundanceTempLBA$T2M, method = "linear", n = 50,
          rule = 1, f = 0, ties = mean, na.rm = TRUE)
swd_interpolatedLBA<-data.frame(swd_interpolatedLBA)
colnames(swd_interpolatedLBA)[colnames(swd_interpolatedLBA) == "x"] <- "T2M"
colnames(swd_interpolatedLBA)[colnames(swd_interpolatedLBA) == "y"] <- "N_swd"

# create 50 points of interpolated data for AlBe flies
swd_interpolatedAlBe<-approx(y = AbundanceTempAlBe$N_swd, x = AbundanceTempAlBe$T2M, method = "linear", n = 50,
          rule = 1, f = 0, ties = mean, na.rm = TRUE)
swd_interpolatedAlBe<-data.frame(swd_interpolatedAlBe)
colnames(swd_interpolatedAlBe)[colnames(swd_interpolatedAlBe) == "x"] <- "T2M" 
colnames(swd_interpolatedAlBe)[colnames(swd_interpolatedAlBe) == "y"] <- "N_swd"

# create 50 points of interpolated data for FrSa flies
swd_interpolatedFrSa<-approx(y = AbundanceTempFrSa$N_swd, x = AbundanceTempFrSa$T2M, method = "linear", n = 50,
          rule = 1, f = 0, ties = mean, na.rm = TRUE)
swd_interpolatedFrSa<-data.frame(swd_interpolatedFrSa)
colnames(swd_interpolatedFrSa)[colnames(swd_interpolatedFrSa) == "x"] <- "T2M" 
colnames(swd_interpolatedFrSa)[colnames(swd_interpolatedFrSa) == "y"] <- "N_swd"
```

#Using charts to visualize the relationship between SWD abundance and NASA temperature data. Stacked line and dot plots visualize temperature (T2M) and SWD population (N_swd) over time. Cross-correlation plots show the strength of correlation between T2M and N_swd at different time points, with tempearture constant (i think) ADD ANALYSIS HERE
```{r}
#Create a plot with both temp and abundance data for specific farms
#FULL BELLY FARM
SWDPlotFBF<-ggplot(data = AbundanceTempFBF, aes(x = YYYYMMDD, y = N_swd)) +
  geom_point(color = "orange", size = 1.5, shape =16, alpha = 0.7) +
  labs(title = "Full Belly Farm SWD Count Over Time", x = "Time", y = "Population Count") +
  theme_minimal()
T2MPlotFBF <- ggplot(AbundanceTempFBF, aes(x=YYYYMMDD, y=T2M)) +
  geom_line(color = "lightblue") +
  labs(title = "Full Belly Farm Temperature Over Time", x = "Time", y = "Temperature (C)") +
  theme_minimal()
# Stack plots vertically using patchwork
grid.arrange(SWDPlotFBF, T2MPlotFBF, nrow = 2)

# create a cross correlation for SWD pop over time for Full Belly data
ccf(swd_interpolatedFBF[["N_swd"]],swd_interpolatedFBF[["T2M"]], ylim = c(-0.5, .5), lag.max = 60, type = c("correlation", "covariance"),
    plot = TRUE, na.action = na.fail,
    main = "FBF SWD Population & Temperature cross-correlation")
```

#Warnings show up after the creation of graphs because for the N_swd dotplot R is drawing from a dataframe that has NA values for the variable of interest (N_swd) due to merging existing SWD counts with weather data for a continous time period. There are many time points that have T2M but no N_swd value, so this warning lets you know that those are being omitted. 

```{r}
#ABF
SWDPlotABF<-ggplot(data = AbundanceTempABF, aes(x = YYYYMMDD, y = N_swd)) +
  geom_point(color = "orange", size = 1.5, shape =16, alpha = 0.7) +
  labs(title = "Adam's Berry Farm SWD Count Over Time", x = "Time", y = "Population Count") +
  theme_minimal()
T2MPlotABF <- ggplot(AbundanceTempFBF, aes(x=YYYYMMDD, y=T2M)) +
  geom_line(color = "lightblue") +
  labs(title = "Adam's Berry Farm Temperature Over Time", x = "Time", y = "Temperature(C)") +
  theme_minimal()
# Stack plots vertically using patchwork
grid.arrange(SWDPlotABF, T2MPlotABF, nrow = 2)

#create a cross correlation for SWD pop over time for ABF data
ccf(swd_interpolatedABF[["N_swd"]],swd_interpolatedABF[["T2M"]], ylim = c(-0.5, .5),lag.max = 60, type = c("correlation", "covariance"),
    plot = TRUE, na.action = na.fail,
    main = "ABF SWD Population & Temperature cross-correlation")
```

```{r}
#CM
SWDPlotCM<-ggplot(data = AbundanceTempCM, aes(x = YYYYMMDD, y = N_swd)) +
  geom_point(color = "orange", size = 1.5, shape =16, alpha = 0.7) +
  labs(title = "Carter's Mountain SWD Count Over Time", x = "Time", y = "Population Count") +
  theme_minimal()
T2MPlotCM <- ggplot(AbundanceTempCM, aes(x=YYYYMMDD, y=T2M)) +
  geom_line(color = "lightblue") +
  labs(title = "Carter's Mountain Temperature Over Time", x = "Time", y = "Temperature (C)") +
  theme_minimal()
# Stack plots vertically using patchwork
grid.arrange(SWDPlotCM, T2MPlotCM, nrow = 2)

#create a cross correlation for SWD pop over time for CM
ccf(swd_interpolatedCM[["N_swd"]],swd_interpolatedCM[["T2M"]],ylim = c(-0.5, .5), lag.max = 60, type = c("correlation", "covariance"),
    plot = TRUE, na.action = na.fail,
    main = "CM SWD Population & Temperature cross-correlation")
```

```{r}
#LBA
SWDPlotLBA<-ggplot(data = AbundanceTempLBA, aes(x = YYYYMMDD, y = N_swd)) +
  geom_point(color = "orange", size = 1.5, shape =16, alpha = 0.7) +
  labs(title = "Lexington Bluegrass Airport SWD Count Over Time", x = "Time", y = "Population Count") +
  theme_minimal()
T2MPlotLBA <- ggplot(AbundanceTempLBA, aes(x=YYYYMMDD, y=T2M)) +
  geom_line(color = "lightblue") +
  labs(title = "Lexington Bluegrass Airport Temperature Over Time", x = "Time", y = "Temperature (C)") +
  theme_minimal()
# Stack plots vertically using patchwork
grid.arrange(SWDPlotLBA, T2MPlotLBA, nrow = 2)

#create a cross correlation for SWD pop over time for LBA
ccf(swd_interpolatedLBA[["N_swd"]],swd_interpolatedLBA[["T2M"]],ylim = c(-0.5, .5), lag.max = 60, type = c("correlation", "covariance"),
    plot = TRUE, na.action = na.fail,
    main = "LBA SWD Population & Temperature cross-correlation")
```

```{r}
#AlBe
SWDPlotAlBe<-ggplot(data = AbundanceTempAlBe, aes(x = YYYYMMDD, y = N_swd)) +
  geom_point(color = "orange", size = 1.5, shape =16, alpha = 0.7) +
  labs(title = "AlBe SWD Count Over Time", x = "Time", y = "Population Count") +
  theme_minimal()
T2MPlotAlBe<- ggplot(AbundanceTempAlBe, aes(x=YYYYMMDD, y=T2M)) +
  geom_line(color = "lightblue") +
  labs(title = "AlBe Temperature Over Time", x = "Time", y = "Temperature (C)") +
  theme_minimal()
# Stack plots vertically using patchwork
grid.arrange(SWDPlotAlBe, T2MPlotAlBe, nrow = 2)

#create a cross correlation for SWD pop over time for Albe
ccf(swd_interpolatedAlBe[["N_swd"]],swd_interpolatedAlBe[["T2M"]],ylim = c(-0.5, .5), lag.max = 60, type = c("correlation", "covariance"),
    plot = TRUE, na.action = na.fail,
    main = "AlBe Population & Temperature cross-correlation")
```

```{r}
#FrSa
SWDPlotFrSa<-ggplot(data = AbundanceTempFrSa, aes(x = YYYYMMDD, y = N_swd)) +
  geom_point(color = "orange", size = 1.5, shape =16, alpha = 0.7) +
  labs(title = "FrSa SWD Count Over Time", x = "Time", y = "Population Count") +
  theme_minimal()
T2MPlotFrSa <- ggplot(AbundanceTempFrSa, aes(x=YYYYMMDD, y=T2M)) +
  geom_line(color = "lightblue") +
  labs(title = "FrSa Temperature Over Time", x = "Time", y = "Temperature (C)") +
  theme_minimal()
# Stack plots vertically using patchwork
grid.arrange(SWDPlotFrSa, T2MPlotFrSa, nrow = 2)
#create a cross correlation for SWD pop over time for FrSa
ccf(swd_interpolatedFrSa[["N_swd"]],swd_interpolatedFrSa[["T2M"]], ylim = c(-0.5, .5), lag.max = 60, type = c("correlation", "covariance"),
    plot = TRUE, na.action = na.fail,
    main = "FrSa Population & Temperature cross-correlation")

```

#Calculating the correlation between temperature today and SWD population in 10 time periods.
```{r}
cor(AbundanceTempABF$T2M, lag(AbundanceTempABF$N_swd, 10), use = "complete.obs")
cor(AbundanceTempFBF$T2M, lag(AbundanceTempFBF$N_swd, 10), use = "complete.obs")
cor(AbundanceTempLBA$T2M, lag(AbundanceTempLBA$N_swd, 10), use = "complete.obs")
cor(AbundanceTempCM$T2M, lag(AbundanceTempCM$N_swd, 10), use = "complete.obs")
cor(AbundanceTempFrSa$T2M, lag(AbundanceTempFrSa$N_swd, 10), use = "complete.obs")
cor(AbundanceTempAlBe$T2M, lag(AbundanceTempAlBe$N_swd, 10), use = "complete.obs")
```

#ADD MORE ANALYSIS HERE
